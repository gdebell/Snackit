<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    {% if title %}
      <title>{{ title }}</title>
    {% else %}
      <title>Something. Something. Something.</title>
    {% endif %}
    <!-- stylesheets -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    {% block css %}{% endblock %}
  </head>
  <body>
      {% block content %}
      {% endblock %}
    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/js/main.js"></script>
    {% block scripts %}{% endblock %}
  </body>
</html>



<!-- //creates a roadmap centered over Denver
var map;
function initMap() {
  var directionsService = new google.maps.DirectionsService();
  var directionsDisplay = new google.maps.DirectionsRenderer();
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 12,
    center: new google.maps.LatLng(39.7033,-105.00),
    mapTypeId: 'roadmap'
  });
  directionsDisplay.setMap(map);
  //ajax request to get long/lat of schools and stores in database
  $.ajax({
    type: 'GET',
    url: '/map/data',
    data: 'json'
  })
   .then((data) => {
    //console.log(data);
    createMarkers(data);
  })
   .fail((err) => {
    console.log(err);
  });
  //on submit, gets the start/end location from DOM
  $('.route').on('submit', (eve)=> {
    eve.preventDefault();
    const start = $('#startAddress').val();
    const end = $('#endAddress').val();
    findRoutes(directionsService, directionsDisplay);
  });
}

//puts school and store markers on the map from database
var locationListings;
function  createMarkers (results) {
  locationListings = results;
  //create school markers
  var appleImage = {
    url: 'http://www.freeiconspng.com/uploads/apple-icon-19.png',
    scaledSize: new google.maps.Size(30, 30)
  };
  for (var i = 0; i < results.schools.length; i++) {
    var lat = parseFloat(results.schools[i].lat);
    var long = parseFloat(results.schools[i].long);
    var latLng = new google.maps.LatLng(lat,long);
    var marker = new google.maps.Marker({
      position: latLng,
      icon: appleImage,
      map: map
    });
  }
  //create store markers
  var storeImage = {
    url: 'https://cdn3.iconfinder.com/data/icons/map-markers-1/512/supermarket-512.png',
    scaledSize: new google.maps.Size(30, 30)
  };
  for (var j = 0; j < results.stores.length; j++) {
    var storeLat = parseFloat(results.stores[j].lat);
    var storeLong = parseFloat(results.stores[j].long);
    var latLngStore = new google.maps.LatLng(storeLat,storeLong);
    var markerStore = new google.maps.Marker({
      position: latLngStore,
      icon: storeImage,
      map: map
    });
  }
}

var shortestStoreLocation;
var shortestTotalDistance = 100000000;
var shortestData;

//find all routes
function findRoutes(directionsService) {
  var result = []
  for (var i = 0; i < locationListings.stores.length; i++ ) {
    var storeLat = parseFloat(locationListings.stores[i].lat);
    var storeLong = parseFloat(locationListings.stores[i].long);
    var first = new google.maps.LatLng(storeLat,storeLong);
    var waypts = [{location: first, stopover: true}];
    // directionsService.route({
    //   origin: document.getElementById('startAddress').value,
    //   destination: document.getElementById('endAddress').value,
    //   waypoints: waypts,
    //   optimizeWaypoints: true,
    //   travelMode: 'DRIVING'
    // }, calculateRoute)

    result.push(new Promise((resolve, reject) => {
      directionsService.route({
        origin: document.getElementById('startAddress').value,
        destination: document.getElementById('endAddress').value,
        waypoints: waypts,
        optimizeWaypoints: true,
        travelMode: 'DRIVING'
      }, (response, status) => {
        var route = response.routes[0];
        var totalDistance = 0;
        for (var i = 0; i < route.legs.length; i++) {
          totalDistance += parseFloat(route.legs[i].distance.text);
        }

        response.totalDistance = totalDistance
        resolve(response);
      })
    }))
  }

  Promise.all(result)
    .then(destinationsAndLengths => {
      var smallest = findSmallest(destinationsAndLengths)
      return smallest
    }).then(smallest => {console.log('smallest', smallest)})
}

//find the shortest route to the store
function calculateRoute (response, status) {
    var route = response.routes[0];
    var totalDistance = 0;
    for (var i = 0; i < route.legs.length; i++) {
      totalDistance += parseFloat(route.legs[i].distance.text);
      //console.log('captured distances...', totalDistance);
    }
    if (totalDistance < shortestTotalDistance) {
      shortestTotalDistance = totalDistance;
      shortestData = response;
      shortestStoreLocation = shortestData.routes[0].legs[0].end_address;
    }
    //console.log('for real shortest distance', shortestTotalDistance, shortestData, shortestStoreLocation);
    //console.log(response, status);
    // var storeLocation = shortestData.routes[0].legs[0].end_address;
    // drawRoute(response, status);
} -->
